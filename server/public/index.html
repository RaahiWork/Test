<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyb Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="custom.css">
    <link rel="stylesheet" href="conference-button-fixes.css">
    <!-- First load livekit client library so it's available for everything else -->
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@1.9.2/dist/livekit-client.umd.min.js"></script>
    <!-- Then load our conference implementation -->
    <script src="livekit-client.js"></script>
    <style>
        /* ...existing code... */
        .private-conversation-preview {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            display: block;
            line-height: 1.4;
            min-height: 1.4em;
            /* Add padding to prevent cut-off */
            padding-bottom: 2px;
        }

        /* Optionally, ensure the tab has enough height */
        .private-conversation-tab {
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }        /* ...existing code... */    </style>
    <!-- Conference Logger Script - Load after livekit -->
    <script src="conference-logger.js"></script>
    <!-- Conference Debug Helper - Load for troubleshooting -->
    <script src="conference-debug.js"></script>
</head>

<body>
    <!-- Debug helper script to ensure URL parameters are detected -->
    <script>
      // Debug script to log URL parameters and check if join parameters are present
      (function() {
        //console.log("Debug: URL parameters check running");
        const urlParams = new URLSearchParams(window.location.search);
        const joinUser = urlParams.get('join');
        const roomName = urlParams.get('room');
        
        if (joinUser && roomName) {
          //console.log(`Debug: Found join parameters - User: ${joinUser}, Room: ${roomName}`);
          // Alert will show on page load if parameters are detected
          setTimeout(() => {
            if (typeof window.openConferencePopup === 'function') {
              //console.log("Debug: window.openConferencePopup is available");
              //alert(`Debug: Join parameters detected!\nUser: ${joinUser}\nRoom: ${roomName}\nWill attempt to open popup...`);
              // Try to open the popup directly
              window.openConferencePopup({ 
                autoJoin: false,
                hostUsername: joinUser, 
                roomName: roomName,
                defaultMicMuted: true,
                defaultVideoMuted: true
              });
            } else {
              //console.error("ERROR: window.openConferencePopup is not defined!");
              //alert("ERROR: Join function not available - check console");
            }
          }, 1500);
        } else {
          //console.log("Debug: No join parameters found in URL");
        }
      })();
    </script>
    
    <script>
      if (!window.LivekitClient) {
        console.error('‚ö†Ô∏è LivekitClient not found ‚Äì check the <script> load!');
      } else {
        // Make LiveKit available globally for private messaging
        window.LiveKit = window.LivekitClient;
        
        // Add microphone permission checker
        window.checkMicrophonePermissions = async function() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('‚ùå getUserMedia not supported');
                    return false;
                }
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Stop the stream immediately after testing
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (err) {
                console.error('‚ùå Microphone access failed:', err.name, err.message);
                return false;
            }
        };
        
        // Test microphone on page load (optional)
        // checkMicrophonePermissions();
      }
    </script>
    <main>
        <aside class="side-pane left-pane">
            <h3>Chat Rooms</h3>
            <!-- Theme Picker -->
            <div class="theme-picker-section" style="margin-bottom:1em;">
                <label for="theme-picker" style="color:#a084ee;font-weight:600;">Theme:</label>
                <select id="theme-picker" style="margin-left:0.5em;padding:0.2em 0.5em;border-radius:6px;border:1px solid #a084ee33;background:#222;color:#fff;font-size:1em;">
                    <option value="fireflies.gif">Fireflies</option>
                    <option value="rain.gif">Rain</option>
                    <option value="snowfall.gif">Snowfall</option>
                    <option value="beach.gif">Beach</option>
                    <option value="fantasy.gif">Fantasy</option>
                    <option value="fireworks.gif">Fireworks</option>
                    <option value="forest.gif">Forest</option>
                    <option value="freedom.gif">Freedom</option>
                    <option value="halloween.gif">Halloween</option>
                </select>
            </div>
            
            <!-- End Theme Picker -->
            <!-- Make chat rooms scrollable after 5 rooms -->
            <div id="rooms-list-scrollable" style="max-height: 260px; overflow-y: auto; margin-bottom: 1em;">
                <div id="rooms-list-container"></div>
            </div>
            <div class="connection-status">Connecting...</div>
            
            <!-- Radio stations section starts immediately after chat rooms -->
            <div class="radio-section">
                <h4>üéµ Radio Stations</h4>
                <div class="radio-player">
                    <div class="radio-controls">
                        <button id="play-pause-btn" class="radio-btn play-btn" title="Play/Pause">
                            <span class="play-icon">‚ñ∂Ô∏è</span>
                        </button>
                        <button id="volume-btn" class="radio-btn volume-btn" title="Volume">
                            <span class="volume-icon">üîä</span>
                        </button>
                        <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="50">
                    </div>
                    
                    <div class="station-info">
                        <div class="current-station">Select a station</div>
                        <div class="station-status">Ready to play</div>
                    </div>
                    
                    <div class="station-list" id="station-list">
                        <!-- Radio stations will be populated here -->
                    </div>
                </div>
            </div>
        </aside>

        <div class="side-pane-toggle left-toggle">‚ò∞</div>
        
        <div class="main-content">
            <div class="current-room-header">
                <div class="room-info-container">
                    <h2 class="current-room-name">Select a room to join</h2>
                    <p class="current-room-description">Choose from available rooms on the left</p>
                </div>
            </div>

            <ul class="chat-display"></ul>

            <div class="typing-container">
                <div class="activity"></div>
            </div>

            <!-- Voice message action buttons, hidden by default -->
            <div id="voice-action-container" style="display:none;gap:0.5em;margin-bottom:0.5em;">
                <audio id="voice-audio-preview" controls style="vertical-align:middle;"></audio>
                <button type="button" id="voice-send-btn">Send</button>
                <button type="button" id="voice-cancel-btn">Cancel</button>
                <button type="button" id="voice-download-btn">Download as MP3</button>
            </div>

            <form class="form-msg" id="message-form" onsubmit="return window.sendMessage(event)">
                <div class="message-input-container">
                    <input type="text" id="message" placeholder="Type a message..." autocomplete="off">
                    <button type="button" id="emoji-btn" class="emoji-btn" aria-label="Select emoji">üòä</button>
                    <button type="button" id="image-upload-btn" class="image-btn" aria-label="Upload image">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input type="file" id="image-file" accept="image/*" style="display:none">
                    <!-- Voice message button and input -->
                    <button type="button" id="voice-record-btn" class="voice-btn" aria-label="Record voice">üé§</button>
                    <input type="file" id="voice-file" accept="audio/*" style="display:none">
                </div>
                <button type="submit" id="send-button">Send</button>
            </form>

            <div id="emoji-picker" class="emoji-picker" style="display: none;">
                <div class="emoji-picker-header">
                    <h3 class="emoji-picker-title">Select Emoji</h3>
                    <button id="close-emoji-picker" class="close-btn">√ó</button>
                </div>
                <div id="emoji-container" class="emoji-container"></div>
            </div>
        </div>
        
        <aside class="side-pane right-pane">
            <div class="pane-header">
                <h3>Online Users</h3>                <button id="logout-btn" class="power-logout-btn" title="Logout">
                    <span class="power-icon"></span>
                </button>
                <button id="help-btn" class="help-btn" title="Help">
                    <span class="info-icon">‚ÑπÔ∏è</span>
                </button>
            </div>
            <div class="stream-btn-global-container" style="margin-bottom:0.7em;">
                <button id="stream-btn-global" class="stream-btn-fancy-global" title="Start Stream/Conference">
                    <span class="stream-btn-fancy-glow">üî¥</span>
                    <span class="stream-btn-fancy-label">Start Stream</span>
                    <svg width="24" height="24" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left:0.2em;vertical-align:middle;"><circle cx="10" cy="10" r="8" stroke="#6c63ff" stroke-width="2" fill="#ffe066"></circle><path d="M7 8V12L12 10L7 8Z" fill="#6c63ff"></path></svg>
                </button>
            </div>
            <section class="user-list"></section>
            <script>
            // Filter and render only online users in the user list
            (function() {
                // This assumes you have a global array or object of users, e.g., window.userList or similar
                // If not, adapt to your actual user list source
                function renderOnlineUsers(users) {
                    const userListSection = document.querySelector('.user-list');
                    if (!userListSection) return;
                    userListSection.innerHTML = '';
                    if (!Array.isArray(users)) return;
                    users.filter(u => u.isOnline).forEach(user => {
                        // Use your existing createUserItem or similar logic
                        let li;
                        if (window.createUserItem) {
                            li = window.createUserItem(user.username, true);
                        } else {
                            li = document.createElement('li');
                            li.textContent = user.username;
                        }
                        userListSection.appendChild(li);
                    });
                }
                // Listen for user list updates (adapt event name as needed)
                document.addEventListener('user-list-updated', function(e) {
                    if (e.detail && Array.isArray(e.detail.users)) {
                        renderOnlineUsers(e.detail.users);
                    }
                });
                // Optionally, trigger initial render if user list is available
                if (window.userList && Array.isArray(window.userList)) {
                    renderOnlineUsers(window.userList);
                }
            })();
            </script>
            
            <!-- Add private messaging section -->
            <div class="private-messaging-section">
                <h4>Private Messages</h4>
                <div class="private-user-search-container">
                    <input
                        id="private-user-search-input"
                        type="text"
                        placeholder="Search users..."
                        autocomplete="off"
                        spellcheck="false"
                    />
                    <div id="private-user-search-results"></div>
                </div>
                <div class="private-conversations" id="private-conversations">
                    <!-- Private conversation tabs will be added here -->
                </div>
            </div>
        </aside>
        
        <div class="side-pane-toggle right-toggle">üë§</div>

    </main>

    <div class="login-overlay">
        <form class="login-form" id="login-form">
            <div style="text-align:center;margin-bottom:0.15em;">
                <div style="
                    font-size:1em;
                    font-weight:600;
                    color:#fff;
                    background: linear-gradient(90deg, #6c63ff 0%, #a084ee 100%);
                    border-radius:6px;
                    padding:0.32em 0.7em;
                    box-shadow:0 1px 6px rgba(108,99,255,0.08);
                    text-shadow:0 1px 4px #6c63ff22,0 1px 0 #fff2;
                    border:1px solid #a084ee33;
                    display:inline-block;
                    margin-bottom:0.08em;
                    letter-spacing:0.01em;
                    max-width: 100%;
                    overflow: visible;
                    white-space: nowrap;
                ">
                    <span style="font-size:1.1em;vertical-align:-0.1em;margin-right:0.18em;">‚ú®</span>
                    Real-time chat fun ‚Äî <span style="color:#ffe066;">no clutter</span>, just 
                    <span style="
                        font-weight:bold;
                        font-size:1.18em;
                        color:#fff;
                        letter-spacing:0.02em;
                        padding:0 0.08em;
                        display:inline;
                        filter: drop-shadow(0 1px 6px #a084ee88);
                    ">vibes</span>.
                </div>
            </div>
            <div class="login-logo" style="margin-bottom:0.09em;">
                <img src="images/logo.png" alt="Vyb Chat Logo" class="logo-image">
            </div>
            <div style="text-align:center;margin-bottom:0.18em;">
                <span style="
                    display:inline-block;
                    font-size:1.5em;
                    font-weight:800;
                    letter-spacing:0.01em;
                    color:#6c63ff;
                    text-shadow:0 1px 6px #a084ee33,0 1px 0 #fff2;
                    background: linear-gradient(90deg, #6c63ff 0%, #a084ee 100%);
                    -webkit-background-clip:text;
                    -webkit-text-fill-color:transparent;
                    background-clip:text;
                ">
                    Welcome to Vyb Chat!
                </span>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;">
                <input type="text" id="login-username" name="name" placeholder="Your username" required autocomplete="off" style="text-align:center;">
                <input type="password" id="login-password" name="password" placeholder="Your password" required autocomplete="off" style="text-align:center;margin-top:0.5em;">
            </div>
            <div id="login-message" class="login-message"></div>
            <div class="login-instructions">
                <p>üÜï New user? Just enter username + password to register<br>
                üîê Existing user? Login with your credentials</p>
                <small>Username: 3-20 chars (letters, numbers, underscore only) ‚Ä¢ Password: 6+ chars</small>
            </div>
            <button type="submit" onclick="handleLoginSubmit(event)" id="login-button" class="login-button">Enter Chat</button>
            <div class="login-support" style="margin-top:0.8em;text-align:center;font-size:0.93em;color:#a084ee;">
                üí¨ Need help? Reach us at <a href="mailto:support@vybchat.com" style="color:#6c63ff;text-decoration:underline;">support@vybchat.com</a>
            </div>
        </form>
    </div>

    <form class="form-join" style="display:none;">
        <input type="hidden" name="room-join" id="room-join">
        <input type="hidden" name="name" id="name">
    </form>

    <!-- Add private message modal -->
    <div id="private-message-modal" class="private-message-modal" style="display: none;">
        <div class="private-message-content">
            <div class="private-message-header">
                <h3 id="private-message-title">Private Message</h3>
                <div style="display:flex;gap:0.5em;align-items:center;">
                    <button id="private-voice-call-btn" class="voice-call-btn" title="Start voice call" style="font-size:1.3em;padding:0.2em 0.5em;border-radius:50%;background:none;border:none;cursor:pointer;">üìû</button>
                    <button id="close-private-message" class="close-btn">√ó</button>
                </div>
            </div>
            <div class="private-message-chat" id="private-message-chat">
                <!-- Private messages will appear here -->
            </div>
            <form class="private-message-form" id="private-message-form">
                <div class="private-message-input-container">
                    <input type="text" id="private-message-input" placeholder="Type a private message..." autocomplete="off">
                    <button type="button" id="private-emoji-btn" class="emoji-btn" aria-label="Select emoji">üòä</button>
                    <button type="button" id="private-image-btn" class="image-btn" aria-label="Upload image">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input type="file" id="private-image-file" accept="image/*" style="display:none">
                </div>
                <button type="submit" id="private-send-button">Send</button>
            </form>
        </div>
    </div>

    <!-- Voice call modal for private messaging -->
    <div id="private-voice-call-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center;">
        <!-- Modal content will be injected by JS -->
    </div>

    <!-- Add User Profile Modal -->
    <div id="user-profile-modal" class="user-profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
        <div class="user-profile-content" style="background: #1a1a2e; border-radius: 12px; padding: 2em; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div class="user-profile-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em;">
                <h3 id="user-profile-title" style="color: #6c63ff; margin: 0;">User Profile</h3>
                <button id="close-user-profile" class="close-btn" style="background: none; border: none; color: #fff; font-size: 1.5em; cursor: pointer;">√ó</button>
            </div>
              <div class="user-profile-info" style="text-align: center;">
                <div class="user-profile-avatar" style="margin-bottom: 1em; position: relative;">
                    <img id="user-profile-avatar-img" src="" alt="User Avatar" style="width: 100%; max-width: 300px; height: 300px; border-radius: 12px; object-fit: cover; border: 3px solid #6c63ff;" onerror="this.src='https://vybchat-media.s3.ap-south-1.amazonaws.com/avatars/default/default.jpg'">
                    <button id="change-avatar-btn" style="display: none; position: absolute; bottom: 10px; right: 10px; background: #6c63ff; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 24px; box-shadow: 0 4px 12px rgba(108, 99, 255, 0.5); transition: all 0.3s ease; z-index: 10;" title="Change Avatar">üì∑</button>
                    <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
                </div>
                <div class="user-profile-details">
                    <h4 id="user-profile-username" style="color: #fff; margin: 0.5em 0;">Username</h4>
                    <p id="user-profile-status" style="color: #a084ee; margin: 0.5em 0;">Status</p>
                </div>
                
                <!-- Avatar upload status -->
                <div id="avatar-upload-status" style="display: none; margin-top: 1em; padding: 0.5em; border-radius: 6px; font-size: 0.9em;"></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="app.js"></script>
    <script src="emoji-handler.js"></script>
    <script src="touch-handler.js"></script>
    <script src="mobile-sidepane.js"></script>
    <script src="auth.js"></script>
    <script src="private-messaging.js"></script>
    <script src="radio-player.js"></script>
    <script src="voice-message.js"></script>
    
    <script>
        // Remove any JS that does: msgInput.focus(); after sending a message
        // Add this utility to conditionally set autofocus (optional, for clarity)
        (function() {
            var isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            var msgInput = document.getElementById('message');
            if (msgInput && !isiOS) {
                msgInput.setAttribute('autofocus', 'autofocus');
            }
        })();

        // --- User search autocomplete for private messaging ---
        (function() {
            // Detect backend API base URL (localhost:3500 or 127.0.0.1:3500)
            const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? `http://${window.location.hostname}:3500`
                : window.location.origin;

            const input = document.getElementById('private-user-search-input');
            const results = document.getElementById('private-user-search-results');
            let users = [];
            let selectedIdx = -1;
            let lastQuery = '';

            function showResults(list) {
                results.innerHTML = '';
                if (!list.length) {
                    const div = document.createElement('div');
                    div.className = 'private-user-search-result no-results';
                    div.textContent = 'No users found';
                    results.appendChild(div);
                    results.classList.add('active');
                    return;
                }
                list.forEach((user, idx) => {
                    const div = document.createElement('div');
                    div.className = 'private-user-search-result';
                    div.textContent = user.displayName || user.username;
                    div.tabIndex = 0;
                    if (idx === selectedIdx) div.classList.add('selected');
                    div.onclick = () => {
                        input.value = user.displayName || user.username;
                        results.classList.remove('active');
                        results.innerHTML = '';
                        // Open private message modal for this user
                        if (window.privateMessaging) window.privateMessaging.openPrivateMessage(user.username);
                    };
                    div.onmouseenter = () => {
                        selectedIdx = idx;
                        updateSelection();
                    };
                    results.appendChild(div);
                });
                results.classList.add('active');
            }

            function updateSelection() {
                Array.from(results.children).forEach((el, idx) => {
                    if (idx === selectedIdx) el.classList.add('selected');
                    else el.classList.remove('selected');
                });
            }

            input.addEventListener('input', function() {
                const q = input.value.trim();
                selectedIdx = -1;
                if (!q) {
                    results.innerHTML = '';
                    results.classList.remove('active');
                    return;
                }
                lastQuery = q;
                fetch(`${API_BASE_URL}/api/search-users?q=${encodeURIComponent(q)}`)
                    .then(res => res.json())
                    .then(data => {
                        users = (data.users || []);
                        showResults(users);
                    })
                    .catch(() => {
                        results.innerHTML = '';
                        results.classList.remove('active');
                    });
            });

            input.addEventListener('keydown', function(e) {
                if (!results.classList.contains('active')) return;
                if (e.key === 'ArrowDown') {
                    if (selectedIdx < users.length - 1) {
                        selectedIdx++;
                        updateSelection();
                    }
                    e.preventDefault();
                } else if (e.key === 'ArrowUp') {
                    if (selectedIdx > 0) {
                        selectedIdx--;
                        updateSelection();
                    }
                    e.preventDefault();
                } else if (e.key === 'Enter') {
                    if (selectedIdx >= 0 && users[selectedIdx]) {
                        input.value = users[selectedIdx].displayName || users[selectedIdx].username;
                        results.classList.remove('active');
                        results.innerHTML = '';
                        if (window.privateMessaging) window.privateMessaging.openPrivateMessage(users[selectedIdx].username);
                    }
                } else if (e.key === 'Escape') {
                    results.classList.remove('active');
                    results.innerHTML = '';
                }
            });

            // Hide results when clicking outside
            document.addEventListener('mousedown', function(e) {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.classList.remove('active');
                }
            });

            // --- Call search on load to populate recent private messages ---
            function triggerRecentPrivateChats() {
                if (window.privateMessaging && typeof window.privateMessaging.getMyName === 'function') {
                    const myName = window.privateMessaging.getMyName();
                    if (typeof socket !== 'undefined' && socket && myName) {
                        socket.emit('getRecentPrivateChats', { user: myName });
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                if (!input.value.trim()) {
                    triggerRecentPrivateChats();
                }
            });

            // Also trigger after login overlay is hidden (login success)
            document.addEventListener('login-success', function() {
                triggerRecentPrivateChats();
            });

            // Patch: fire custom event after login in auth.js
        })();        // --- User Profile Modal Management ---
        (function() {
            const modal = document.getElementById('user-profile-modal');
            const closeBtn = document.getElementById('close-user-profile');
            const avatarImg = document.getElementById('user-profile-avatar-img');
            const statusEl = document.getElementById('user-profile-status');
            const changeAvatarBtn = document.getElementById('change-avatar-btn');
            const avatarFileInput = document.getElementById('avatar-file-input');
            const avatarUploadStatus = document.getElementById('avatar-upload-status');

            let currentProfileUsername = null;

            function showUserProfile(username, isOnline = true, avatarSrc = null) {
                if (!username) return;

                //console.log('Showing profile for:', username);
                
                currentProfileUsername = username;
                
                // Set username and status
                statusEl.textContent = isOnline ? 'Online' : 'Offline';
                statusEl.style.color = isOnline ? '#4CAF50' : '#f44336';                // Show/hide change avatar button based on whether this is the current user
                //
                //
                //
                // Temporarily always show button for testing
                changeAvatarBtn.style.display = 'block'; // Changed to always show for testing
                //changeAvatarBtn.style.display = (username === currentUser) ? 'block' : 'none';                // Use the simplified MongoDB-only avatar loading system
                if (avatarSrc) {
                    //console.log('Using avatar from user list:', avatarSrc);
                    avatarImg.src = avatarSrc;
                } else {
                    // Use the main app's getAvatarUrl function for consistent avatar loading
                    avatarImg.src = 'https://vybchat-media.s3.ap-south-1.amazonaws.com/avatars/default/default.jpg';
                }
                modal.style.display = 'flex';
            }
            // Avatar upload functionality
            function showUploadStatus(message, isError = false) {
                avatarUploadStatus.textContent = message;
                avatarUploadStatus.style.display = 'block';
                avatarUploadStatus.style.backgroundColor = isError ? '#f44336' : '#4CAF50';
                avatarUploadStatus.style.color = 'white';
                
                // Hide status after 3 seconds
                setTimeout(() => {
                    avatarUploadStatus.style.display = 'none';
                }, 3000);
            }

            function uploadAvatar(file) {
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showUploadStatus('Please select a valid image file.', true);
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showUploadStatus('Image size must be less than 5MB.', true);
                    return;
                }

                showUploadStatus('Uploading avatar...');                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    
                    // Detect backend API base URL (localhost:3500 or 127.0.0.1:3500)
                    const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                        ? `http://${window.location.hostname}:3500`
                        : window.location.origin;
                    
                    // Send to server
                    fetch(`${API_BASE_URL}/api/avatar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: currentProfileUsername,
                            image: base64Image
                        })                    })                    .then(response => {
                        //
                        //
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        return response.json();
                    })                    .then(data => {
                        //
                        if (data.success) {
                            showUploadStatus('Avatar updated successfully!');
                            // Update the avatar image in the modal
                            avatarImg.src = data.url + '?t=' + Date.now(); // Add timestamp to force refresh
                            
                            // Cache UUID-based avatar info if provided
                            if (data.avatarId && data.format && window.avatarUuidCache) {
                                const lowerUsername = currentProfileUsername.toLowerCase();
                                window.avatarUuidCache[lowerUsername] = {
                                    avatarId: data.avatarId,
                                    format: data.format
                                };
                            }
                            
                            // Also update avatar in user list and messages if it's the current user
                            if (currentProfileUsername === localStorage.getItem('username')) {                                updateUserAvatarsInUI(data.url);
                                
                                // Trigger user list refresh to show new avatar immediately
                                if (window.socket && window.socket.connected && window.currentRoom) {
                                    // Request updated user list from server to refresh avatars
                                    window.socket.emit('getUserList', { room: window.currentRoom });
                                }
                            }
                        } else {
                            showUploadStatus(data.error || 'Failed to upload avatar.', true);                        }
                    })
                    .catch(error => {
                        //
                        showUploadStatus('Failed to upload avatar: ' + error.message, true);
                    });
                };
                reader.readAsDataURL(file);
            }            function updateUserAvatarsInUI(newAvatarUrl) {
                const username = localStorage.getItem('username');
                if (!username) return;

                // Update all user avatars in the UI
                const userAvatars = document.querySelectorAll(`img[alt*="${username}"]`);
                userAvatars.forEach(img => {
                    if (img.src.includes('avatars') || img.src.includes('ui-avatars.com')) {
                        img.src = newAvatarUrl + '?t=' + Date.now();
                    }
                });

                // Update user list avatars specifically
                const userListAvatars = document.querySelectorAll('.profile-avatar-img--small');
                userListAvatars.forEach(img => {
                    if (img.alt && img.alt.includes(username)) {
                        img.src = newAvatarUrl + '?t=' + Date.now();
                    }
                });

                // Update message avatars for current user
                const messageAvatars = document.querySelectorAll('.message-avatar');
                messageAvatars.forEach(img => {
                    if (img.closest('.message') && img.closest('.message').dataset.username === username) {
                        img.src = newAvatarUrl + '?t=' + Date.now();
                    }
                });
            }

            // Event listeners
            changeAvatarBtn.onclick = function() {
                avatarFileInput.click();
            };

            avatarFileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadAvatar(file);
                }
                // Reset input so same file can be selected again
                e.target.value = '';
            };

            // Hover effect for change avatar button
            changeAvatarBtn.onmouseover = function() {
                this.style.transform = 'scale(1.1)';
                this.style.backgroundColor = '#5a52e8';
            };

            changeAvatarBtn.onmouseout = function() {
                this.style.transform = 'scale(1)';
                this.style.backgroundColor = '#6c63ff';
            };

            closeBtn.onclick = function() {
                modal.style.display = 'none';
                currentProfileUsername = null;
            };

            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    currentProfileUsername = null;
                }
            };

            // Make function globally available
            window.showUserProfile = showUserProfile;

            // Add click handlers to user list items
            document.addEventListener('click', function(e) {
                if (e.target.closest('.view-profile-btn') || e.target.closest('.profile-avatar-img--small')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const userItem = e.target.closest('.online-user-item');
                    if (userItem) {
                        const username = userItem.dataset.username || userItem.querySelector('.profile-username').textContent.trim();
                        const isOnline = userItem.classList.contains('online') || !userItem.classList.contains('offline');
                        
                        // Get the actual avatar source from the user list item
                        const userListAvatar = userItem.querySelector('.profile-avatar-img--small');
                        const avatarSrc = userListAvatar ? userListAvatar.src : null;
                        
                        showUserProfile(username, isOnline, avatarSrc);
                    }
                }
            });

            // Modify user list creation to include view profile button
            const originalCreateUserItem = window.createUserItem;
            window.createUserItem = function(username, isOnline) {
                if (originalCreateUserItem) {
                    return originalCreateUserItem(username, isOnline);
                }
                
                // Fallback if createUserItem doesn't exist
                const li = document.createElement('li');
                li.className = 'online-user-item';
                li.dataset.username = username;
                
                const avatarUrl = `https://vybchat-media.s3.ap-south-1.amazonaws.com/avatars/${username}/${username}.png`;
                
                li.innerHTML = `
                    <img src="${avatarUrl}" alt="${username}'s Avatar" class="profile-avatar-img profile-avatar-img--small" 
                         onerror="this.src='https://vybchat-media.s3.ap-south-1.amazonaws.com/avatars/default/default.jpg'"
                         style="cursor: pointer;" title="View Profile">
                    <span class="profile-username">${username}</span>
                    <button class="view-profile-btn" title="View Profile" style="margin-left: auto; background: none; border: none; color: #6c63ff; cursor: pointer; font-size: 0.9em; padding: 0.2em 0.5em;">üë§</button>
                `;
                
                return li;
            };
        })();
        // --- LiveKit Private Voice Call Logic ---
        (function() {
            const callBtn = document.getElementById('private-voice-call-btn');
            const callModal = document.getElementById('private-voice-call-modal');
            let livekitRoom = null;
            let localTrack = null;
            let isMuted = false;
            // let currentCallUser = null;
            let remoteAudioElements = [];

            // Helper: Generate a unique room name for 1:1 call (sorted usernames)
            function getPrivateCallRoomName(userA, userB) {
                return 'vybchat-voicecall-' + [userA, userB].sort().join('-');
            }

            // Helper: Get current username
            function getMyUsername() {
                return localStorage.getItem('username');
            }

            // Helper: Get LiveKit server URL and token (replace with your backend logic)
            async function getLiveKitToken(roomName, username) {
                const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                    ? `http://${window.location.hostname}:3500`
                    : window.location.origin;
                const res = await fetch(`${API_BASE_URL}/api/livekit-token?room=${encodeURIComponent(roomName)}&username=${encodeURIComponent(username)}`);
                if (!res.ok) throw new Error('Failed to get LiveKit token');
                return await res.json(); // { url, token }
            }

            // Show call modal UI
            function showCallModal({ onHangup, targetUser }) {
                callModal.innerHTML = `
                    <div style="background:#222;padding:2em 2em 1.5em 2em;border-radius:16px;max-width:350px;width:90vw;text-align:center;position:relative;">
                        <h2 style="color:#a084ee;margin-bottom:1em;">Voice Call</h2>
                        <div id="call-status" style="color:#fff;margin-bottom:1em;">Connecting...</div>
                        <button id="mute-btn" style="font-size:1.5em;margin-right:1em;">üîá</button>
                        <button id="hangup-btn" style="font-size:1.5em;color:#f44336;">Hang Up</button>
                        <audio id="remote-audio" autoplay style="display:none;"></audio>
                    </div>
                `;
                callModal.style.display = 'flex';
                document.getElementById('hangup-btn').onclick = () => {
                    if (onHangup) onHangup();
                };
                document.getElementById('mute-btn').onclick = () => {
                    isMuted = !isMuted;
                    if (localTrack) localTrack.muted = isMuted;
                    document.getElementById('mute-btn').textContent = isMuted ? 'üîà' : 'üîá';
                };
            }

            // Hide call modal
            function hideCallModal() {
                callModal.style.display = 'none';
                callModal.innerHTML = '';
                // Remove remote audio elements
                remoteAudioElements.forEach(el => el.remove());
                remoteAudioElements = [];
            }

            // Start or join a LiveKit call
            async function startVoiceCall(targetUser) {
                const myName = getMyUsername();
                if (!myName || !targetUser) return;
                const roomName = getPrivateCallRoomName(myName, targetUser);
                showCallModal({ onHangup: endVoiceCall, targetUser });
                document.getElementById('call-status').textContent = 'Connecting...';
                try {
                    const { url, token } = await getLiveKitToken(roomName, myName);
                    livekitRoom = new window.LiveKit.Room();
                    // Publish local audio
                    localTrack = await window.LiveKit.createLocalAudioTrack();
                    await livekitRoom.connect(url, token);
                    await livekitRoom.localParticipant.publishTrack(localTrack);
                    document.getElementById('call-status').textContent = 'In call with ' + targetUser;
                    // Play remote audio
                    livekitRoom.on('trackSubscribed', (track, publication, participant) => {
                        if (track.kind === 'audio') {
                            const audioEl = track.attach();
                            audioEl.autoplay = true;
                            audioEl.style.display = 'none';
                            callModal.appendChild(audioEl);
                            remoteAudioElements.push(audioEl);
                        }
                    });
                    // Remove remote audio on unsubscribe
                    livekitRoom.on('trackUnsubscribed', (track, publication, participant) => {
                        if (track.kind === 'audio') {
                            const els = remoteAudioElements.filter(el => el.srcObject === track.mediaStreamTrack);
                            els.forEach(el => el.remove());
                            remoteAudioElements = remoteAudioElements.filter(el => el.srcObject !== track.mediaStreamTrack);
                        }
                    });
                    // Handle remote hangup
                    livekitRoom.on('disconnected', () => {
                        endVoiceCall();
                    });
                } catch (err) {
                    document.getElementById('call-status').textContent = 'Call failed: ' + err.message;
                    setTimeout(endVoiceCall, 2000);
                }
            }

            // End call and cleanup
            function endVoiceCall() {
                if (localTrack) {
                    localTrack.stop();
                    localTrack = null;
                }
                if (livekitRoom) {
                    livekitRoom.disconnect();
                    livekitRoom = null;
                }
                hideCallModal();
            }

            // Listen for call button click
            if (callBtn) {
                callBtn.onclick = async function() {
                    // Get the username of the private message target
                    const title = document.getElementById('private-message-title');
                    let targetUser = null;
                    if (title && title.textContent) {
                        // Try to extract username from title (e.g., "Private Message: username")
                        const match = title.textContent.match(/Private Message\s*:?\s*(.+)/i);
                        targetUser = match ? match[1].trim() : null;
                    }
                    if (!targetUser) {
                        // Fallback: try to get from modal dataset
                        const modal = document.getElementById('private-message-modal');
                        if (modal && modal.dataset && modal.dataset.username) {
                            targetUser = modal.dataset.username;
                        }
                    }
                    if (!targetUser) {
                        alert('Could not determine user to call.');
                        return;
                    }
                    startVoiceCall(targetUser);
                };
            }

            // Allow closing modal by clicking outside
            callModal.onclick = function(e) {
                if (e.target === callModal) {
                    endVoiceCall();
                }
            };

            // Expose for debugging
            window._livekitVoiceCall = { startVoiceCall, endVoiceCall };
        })();
    </script>    <script>      // Attach click handler to open LiveKit conference popup
      // Also auto-join conference for the current user
      (function() {
        // Function to check if stream feature is enabled
        async function checkStreamFeature() {
          try {
            const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
              ? `http://${window.location.hostname}:3500`
              : window.location.origin;
              
            const response = await fetch(`${API_BASE_URL}/api/config`);
            const config = await response.json();
            return config.enableStream === true;
          } catch (error) {
            console.error('Failed to check stream feature:', error);
            return false; // Default to disabled if can't check
          }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
          var streamBtn = document.getElementById('stream-btn-global');
          
          if (streamBtn) {
            // Check if stream feature is enabled
            const isStreamEnabled = await checkStreamFeature();
            
            if (!isStreamEnabled) {
              // Disable the stream button and update its appearance
              streamBtn.disabled = true;
              streamBtn.style.opacity = '0.5';
              streamBtn.style.cursor = 'not-allowed';
              streamBtn.title = 'Stream feature is currently disabled';
              streamBtn.innerHTML = '<span class="stream-btn-fancy-glow">üö´</span> <span class="stream-btn-fancy-label">Stream Disabled</span>';
              
              // Add click handler to show disabled message
              streamBtn.addEventListener('click', function(e) {
                e.preventDefault();
                alert('The streaming feature is currently disabled. Please contact the administrator.');
              });
            } else if (typeof window.openConferencePopup === 'function') {
              //("Debug: Stream button handler attached");
              // Stream is enabled, add normal functionality
              streamBtn.addEventListener('click', function(e) {
                e.preventDefault();
                window.openConferencePopup({
                  autoJoin: true,
                  defaultMicMuted: true,
                  defaultVideoMuted: true,
                  isHostStarting: true  // Flag to indicate this is a fresh host start
                });
              });
            } else {
              console.error("ERROR: window.openConferencePopup not available for stream button");
              streamBtn.addEventListener('click', function(e) {
                e.preventDefault();
                alert("Conference popup function is not available. Please refresh the page.");
              });
            }
          }
          
          // Run URL parameter check again after DOM is loaded
          // This serves as a backup to the earlier check
          const urlParams = new URLSearchParams(window.location.search);
          const joinUser = urlParams.get('join');
          const roomName = urlParams.get('room');
          
          if (joinUser && roomName && typeof window.openConferencePopup === 'function') {
            //console.log("DOMContentLoaded: Opening conference popup for", joinUser, roomName);
            window.openConferencePopup({ 
              autoJoin: false,
              hostUsername: joinUser, 
              roomName: roomName,
              defaultMicMuted: true,
              defaultVideoMuted: true
            });
          }
        });
      })();
    </script>

</body>

</html>