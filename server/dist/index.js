const a1_0xfca26b=a1_0x1cfa;(function(_0x42f575,_0x5de503){const _0x395c50=a1_0x1cfa,_0x5e8f5b=_0x42f575();while(!![]){try{const _0x12ea85=parseInt(_0x395c50(0x136))/0x1*(-parseInt(_0x395c50(0x127))/0x2)+-parseInt(_0x395c50(0x126))/0x3*(parseInt(_0x395c50(0x125))/0x4)+parseInt(_0x395c50(0x11c))/0x5+-parseInt(_0x395c50(0x13e))/0x6+parseInt(_0x395c50(0x166))/0x7*(parseInt(_0x395c50(0x11a))/0x8)+parseInt(_0x395c50(0x128))/0x9+-parseInt(_0x395c50(0x171))/0xa;if(_0x12ea85===_0x5de503)break;else _0x5e8f5b['push'](_0x5e8f5b['shift']());}catch(_0x5f40eb){_0x5e8f5b['push'](_0x5e8f5b['shift']());}}}(a1_0x4e22,0xa7fb4));import a1_0x5d5c9d from'express';function a1_0x4e22(){const _0x4a819c=['leave','Invalid\x20image\x20data\x20format','createdAt','imageMessage','urlencoded','activity','System','findByUsername','join','enterRoom','\x20has\x20joined\x20the\x20room','status','filter','from','217FFXkvm','message','getRooms','username\x20createdAt','roomList','http://localhost:5500','Internal\x20server\x20error\x20during\x20registration','/api/users','readdir','DateTimeFormat','find','5083830okPyFk','\x20has\x20left\x20the\x20room','dirname','You\x20have\x20joined\x20the\x20','GET,\x20POST,\x20PUT,\x20DELETE,\x20OPTIONS','/api/emojis','get','public','env','warn','startsWith','connection','Access-Control-Allow-Headers','save','mkdir','Origin,\x20X-Requested-With,\x20Content-Type,\x20Accept','http://127.0.0.1:5500','Failed\x20to\x20load\x20emojis','Validation\x20failed','243944llpHnb','header','3620755ZOubdU','Error\x20fetching\x20users:','.png','sort','Error\x20sending\x20image:\x20','map','extname','PORT','numeric','4Bpviqu','378495pzgZvF','357908nrJSyX','2019258SnibmF','/api/register','json','keepalive','Username\x20and\x20password\x20are\x20required','User\x20registered\x20successfully','url','Failed\x20to\x20fetch\x20users','Error\x20reading\x20emoji\x20directory:','toLowerCase','users','error','static','.webp','3MnEwuu','broadcast','disconnect','Invalid\x20username\x20or\x20password','/api/login','comparePassword','Invalid\x20image\x20format.\x20Please\x20try\x20again.','ValidationError','206004qJoWgs','Error\x20sending\x20image\x20message:','NODE_ENV','room','production','use','post','userList','default','10mb','setUsers','data:image/','length','emit','.gif','access','Username\x20already\x20taken','body','Login\x20error:','.jpeg','Internal\x20server\x20error\x20during\x20login','No\x20emojis\x20found.\x20Add\x20emoji\x20images\x20to:','emojis','.jpg','Welcome\x20to\x20Vyb\x20Chat!','username'];a1_0x4e22=function(){return _0x4a819c;};return a1_0x4e22();}import{Server}from'socket.io';function a1_0x1cfa(_0xa5bbba,_0x2431dc){const _0x4e2284=a1_0x4e22();return a1_0x1cfa=function(_0x1cfae0,_0x5146ce){_0x1cfae0=_0x1cfae0-0x112;let _0x565217=_0x4e2284[_0x1cfae0];return _0x565217;},a1_0x1cfa(_0xa5bbba,_0x2431dc);}import a1_0x3acb70 from'path';import{fileURLToPath}from'url';import a1_0xdfaf81 from'fs/promises';import a1_0x1627d0 from'dotenv';import a1_0x50b74b from'./config/database.js';import a1_0x4087d6 from'./models/User.js';a1_0x1627d0['config']();const __filename=fileURLToPath(import.meta[a1_0xfca26b(0x12e)]),__dirname=a1_0x3acb70[a1_0xfca26b(0x173)](__filename),PORT=process[a1_0xfca26b(0x179)][a1_0xfca26b(0x123)]||0xdac,ADMIN=a1_0xfca26b(0x15e),app=a1_0x5d5c9d();a1_0x50b74b(),app['use'](a1_0x5d5c9d['json']({'limit':a1_0xfca26b(0x147)})),app[a1_0xfca26b(0x143)](a1_0x5d5c9d[a1_0xfca26b(0x15c)]({'extended':!![]})),app['use']((_0x47a1ff,_0x27effd,_0x4f849f)=>{const _0x3697f5=a1_0xfca26b;_0x27effd[_0x3697f5(0x11b)]('Access-Control-Allow-Origin',_0x3697f5(0x117)),_0x27effd[_0x3697f5(0x11b)]('Access-Control-Allow-Methods',_0x3697f5(0x175)),_0x27effd[_0x3697f5(0x11b)](_0x3697f5(0x113),_0x3697f5(0x116));if(_0x47a1ff['method']==='OPTIONS')return _0x27effd['sendStatus'](0xc8);_0x4f849f();});const publicPath=a1_0x3acb70['join'](__dirname,a1_0xfca26b(0x178)),emojisPath=a1_0x3acb70[a1_0xfca26b(0x160)](publicPath,a1_0xfca26b(0x154)),imagesPath=a1_0x3acb70['join'](publicPath,'images');try{await a1_0xdfaf81[a1_0xfca26b(0x115)](emojisPath,{'recursive':!![]}),await a1_0xdfaf81[a1_0xfca26b(0x115)](imagesPath,{'recursive':!![]});const files=await a1_0xdfaf81[a1_0xfca26b(0x16e)](emojisPath);files[a1_0xfca26b(0x14a)]===0x0&&console[a1_0xfca26b(0x17a)](a1_0xfca26b(0x153),emojisPath);}catch(a1_0x508e8d){console[a1_0xfca26b(0x133)]('Error\x20ensuring\x20directories\x20exist:',a1_0x508e8d);}app[a1_0xfca26b(0x143)](a1_0x5d5c9d[a1_0xfca26b(0x134)](publicPath)),app[a1_0xfca26b(0x177)](a1_0xfca26b(0x176),async(_0x344448,_0x46631b)=>{const _0xb1cd17=a1_0xfca26b;try{try{await a1_0xdfaf81[_0xb1cd17(0x14d)](emojisPath);}catch(_0x51735c){return await a1_0xdfaf81[_0xb1cd17(0x115)](emojisPath,{'recursive':!![]}),_0x46631b['json']([]);}const _0x138de5=await a1_0xdfaf81[_0xb1cd17(0x16e)](emojisPath),_0x5da7f9=_0x138de5[_0xb1cd17(0x164)](_0x411379=>{const _0x30dc6d=_0xb1cd17,_0x3e19eb=a1_0x3acb70[_0x30dc6d(0x122)](_0x411379)[_0x30dc6d(0x131)]();return[_0x30dc6d(0x11e),_0x30dc6d(0x155),_0x30dc6d(0x151),_0x30dc6d(0x14c),_0x30dc6d(0x135)]['includes'](_0x3e19eb);});_0x46631b['json'](_0x5da7f9);}catch(_0xb94bd){console[_0xb1cd17(0x133)](_0xb1cd17(0x130),_0xb94bd),_0x46631b['status'](0x1f4)[_0xb1cd17(0x12a)]({'error':_0xb1cd17(0x118),'details':_0xb94bd[_0xb1cd17(0x167)]});}}),app['post'](a1_0xfca26b(0x129),async(_0x4f4d91,_0xaa9349)=>{const _0xe89ae4=a1_0xfca26b;try{const {username:_0x52294f,password:_0x1417c9}=_0x4f4d91['body'];if(!_0x52294f||!_0x1417c9)return _0xaa9349[_0xe89ae4(0x163)](0x190)[_0xe89ae4(0x12a)]({'error':'Username\x20and\x20password\x20are\x20required'});const _0x4d3c11=await a1_0x4087d6[_0xe89ae4(0x15f)](_0x52294f);if(_0x4d3c11)return _0xaa9349[_0xe89ae4(0x163)](0x199)[_0xe89ae4(0x12a)]({'error':_0xe89ae4(0x14e)});const _0x37b5ae=new a1_0x4087d6({'username':_0x52294f[_0xe89ae4(0x131)](),'password':_0x1417c9});await _0x37b5ae[_0xe89ae4(0x114)](),_0xaa9349[_0xe89ae4(0x163)](0xc9)[_0xe89ae4(0x12a)]({'message':_0xe89ae4(0x12d),'user':{'id':_0x37b5ae['_id'],'username':_0x37b5ae[_0xe89ae4(0x157)],'createdAt':_0x37b5ae['createdAt']}});}catch(_0x210890){if(_0x210890['name']===_0xe89ae4(0x13d)){const _0xff4899=Object['values'](_0x210890['errors'])[_0xe89ae4(0x121)](_0xcc3ed8=>_0xcc3ed8[_0xe89ae4(0x167)]);return _0xaa9349[_0xe89ae4(0x163)](0x190)[_0xe89ae4(0x12a)]({'error':_0xe89ae4(0x119),'details':_0xff4899});}console[_0xe89ae4(0x133)]('Registration\x20error:',_0x210890),_0xaa9349['status'](0x1f4)['json']({'error':_0xe89ae4(0x16c)});}}),app[a1_0xfca26b(0x144)](a1_0xfca26b(0x13a),async(_0x6a7eab,_0x4576bc)=>{const _0x5570bd=a1_0xfca26b;try{const {username:_0x2799ae,password:_0x446222}=_0x6a7eab[_0x5570bd(0x14f)];if(!_0x2799ae||!_0x446222)return _0x4576bc[_0x5570bd(0x163)](0x190)['json']({'error':_0x5570bd(0x12c)});const _0x1ab49b=await a1_0x4087d6[_0x5570bd(0x15f)](_0x2799ae);if(!_0x1ab49b)return _0x4576bc[_0x5570bd(0x163)](0x191)[_0x5570bd(0x12a)]({'error':_0x5570bd(0x139)});const _0x527e06=await _0x1ab49b[_0x5570bd(0x13b)](_0x446222);if(!_0x527e06)return _0x4576bc['status'](0x191)['json']({'error':'Invalid\x20username\x20or\x20password'});_0x4576bc[_0x5570bd(0x12a)]({'message':'Login\x20successful','user':{'id':_0x1ab49b['_id'],'username':_0x1ab49b[_0x5570bd(0x157)],'createdAt':_0x1ab49b[_0x5570bd(0x15a)]}});}catch(_0x30755c){console[_0x5570bd(0x133)](_0x5570bd(0x150),_0x30755c),_0x4576bc[_0x5570bd(0x163)](0x1f4)[_0x5570bd(0x12a)]({'error':_0x5570bd(0x152)});}}),app[a1_0xfca26b(0x177)](a1_0xfca26b(0x16d),async(_0x41a12a,_0x2d16c0)=>{const _0x2fa2d1=a1_0xfca26b;try{const _0x5dff00=await a1_0x4087d6['find']({},_0x2fa2d1(0x169))[_0x2fa2d1(0x11f)]({'createdAt':-0x1});_0x2d16c0['json']({'count':_0x5dff00[_0x2fa2d1(0x14a)],'users':_0x5dff00});}catch(_0x13ce1a){console['error'](_0x2fa2d1(0x11d),_0x13ce1a),_0x2d16c0[_0x2fa2d1(0x163)](0x1f4)[_0x2fa2d1(0x12a)]({'error':_0x2fa2d1(0x12f)});}});const expressServer=app['listen'](PORT,()=>{}),UsersState={'users':[],'setUsers':function(_0x18e77f){const _0x43eaea=a1_0xfca26b;this[_0x43eaea(0x132)]=_0x18e77f;}},io=new Server(expressServer,{'cors':{'origin':process[a1_0xfca26b(0x179)][a1_0xfca26b(0x140)]===a1_0xfca26b(0x142)?![]:[a1_0xfca26b(0x16b),a1_0xfca26b(0x117)]},'pingTimeout':0xea60,'pingInterval':0x61a8});io['on'](a1_0xfca26b(0x112),_0x5885a4=>{const _0x176677=a1_0xfca26b;_0x5885a4[_0x176677(0x14b)]('message',buildMsg(ADMIN,_0x176677(0x156))),_0x5885a4['on'](_0x176677(0x12b),()=>{}),_0x5885a4['on'](_0x176677(0x168),()=>{const _0x420dba=_0x176677;_0x5885a4[_0x420dba(0x14b)](_0x420dba(0x16a),{'rooms':getAllActiveRooms()});}),_0x5885a4['on'](_0x176677(0x161),({name:_0x41b085,room:_0x17a020})=>{const _0x61eb09=_0x176677,_0x4ea794=getUser(_0x5885a4['id'])?.['room'];_0x4ea794&&(_0x5885a4[_0x61eb09(0x158)](_0x4ea794),io['to'](_0x4ea794)[_0x61eb09(0x14b)](_0x61eb09(0x167),buildMsg(ADMIN,_0x41b085+'\x20has\x20left\x20the\x20room')));const _0x5cbd2b=activateUser(_0x5885a4['id'],_0x41b085,_0x17a020);_0x4ea794&&io['to'](_0x4ea794)[_0x61eb09(0x14b)]('userList',{'users':getUsersInRoom(_0x4ea794)}),_0x5885a4[_0x61eb09(0x160)](_0x5cbd2b[_0x61eb09(0x141)]),_0x5885a4[_0x61eb09(0x14b)](_0x61eb09(0x167),buildMsg(ADMIN,_0x61eb09(0x174)+_0x5cbd2b[_0x61eb09(0x141)]+'\x20chat\x20room')),_0x5885a4[_0x61eb09(0x137)]['to'](_0x5cbd2b['room'])[_0x61eb09(0x14b)](_0x61eb09(0x167),buildMsg(ADMIN,_0x5cbd2b['name']+_0x61eb09(0x162))),io['to'](_0x5cbd2b[_0x61eb09(0x141)])[_0x61eb09(0x14b)](_0x61eb09(0x145),{'users':getUsersInRoom(_0x5cbd2b['room'])}),io[_0x61eb09(0x14b)](_0x61eb09(0x16a),{'rooms':getAllActiveRooms()});}),_0x5885a4['on'](_0x176677(0x138),()=>{const _0x3f5833=_0x176677,_0x1d4bdb=getUser(_0x5885a4['id']);userLeavesApp(_0x5885a4['id']),_0x1d4bdb&&(io['to'](_0x1d4bdb['room'])[_0x3f5833(0x14b)](_0x3f5833(0x167),buildMsg(ADMIN,_0x1d4bdb['name']+_0x3f5833(0x172))),io['to'](_0x1d4bdb[_0x3f5833(0x141)])['emit'](_0x3f5833(0x145),{'users':getUsersInRoom(_0x1d4bdb[_0x3f5833(0x141)])}),io['emit']('roomList',{'rooms':getAllActiveRooms()}));}),_0x5885a4['on'](_0x176677(0x167),({name:_0x584a2b,text:_0x56ee81})=>{const _0x46db2c=_0x176677,_0x158e93=getUser(_0x5885a4['id'])?.[_0x46db2c(0x141)];_0x158e93&&io['to'](_0x158e93)[_0x46db2c(0x14b)](_0x46db2c(0x167),buildMsg(_0x584a2b,_0x56ee81));}),_0x5885a4['on'](_0x176677(0x15b),({name:_0x102ed2,image:_0xfdcfe0})=>{const _0x575a4f=_0x176677,_0x177c3e=getUser(_0x5885a4['id'])?.['room'];if(_0x177c3e){if(!_0xfdcfe0||!_0xfdcfe0[_0x575a4f(0x17b)](_0x575a4f(0x149))){console[_0x575a4f(0x133)](_0x575a4f(0x159)),_0x5885a4[_0x575a4f(0x14b)](_0x575a4f(0x167),buildMsg(ADMIN,_0x575a4f(0x13c)));return;}try{io['to'](_0x177c3e)[_0x575a4f(0x14b)](_0x575a4f(0x167),buildMsg(_0x102ed2,null,_0xfdcfe0));}catch(_0xf5647){console[_0x575a4f(0x133)](_0x575a4f(0x13f),_0xf5647),_0x5885a4[_0x575a4f(0x14b)](_0x575a4f(0x167),buildMsg(ADMIN,_0x575a4f(0x120)+_0xf5647[_0x575a4f(0x167)]));}}else _0x5885a4[_0x575a4f(0x14b)](_0x575a4f(0x167),buildMsg(ADMIN,'You\x20must\x20join\x20a\x20room\x20before\x20sending\x20images'));}),_0x5885a4['on'](_0x176677(0x15d),_0x57bce0=>{const _0x2fc2b6=_0x176677,_0x48ca4e=getUser(_0x5885a4['id'])?.[_0x2fc2b6(0x141)];_0x48ca4e&&_0x5885a4['broadcast']['to'](_0x48ca4e)['emit']('activity',_0x57bce0);});});function buildMsg(_0x4534bc,_0xd2d73f,_0x3cf470=null){const _0x56ce9b=a1_0xfca26b;return{'name':_0x4534bc,'text':_0xd2d73f,'image':_0x3cf470,'time':new Intl[(_0x56ce9b(0x16f))](_0x56ce9b(0x146),{'hour':'numeric','minute':_0x56ce9b(0x124),'second':_0x56ce9b(0x124)})['format'](new Date())};}function activateUser(_0x515a92,_0x2d48c2,_0x231c4a){const _0x3087fc=a1_0xfca26b,_0x48de48={'id':_0x515a92,'name':_0x2d48c2,'room':_0x231c4a};return UsersState[_0x3087fc(0x148)]([_0x48de48,...UsersState[_0x3087fc(0x132)][_0x3087fc(0x164)](_0x2ce635=>_0x2ce635['id']!==_0x515a92)]),_0x48de48;}function userLeavesApp(_0x1899bb){const _0x30a214=a1_0xfca26b;UsersState[_0x30a214(0x148)](UsersState[_0x30a214(0x132)][_0x30a214(0x164)](_0x34d6d2=>_0x34d6d2['id']!==_0x1899bb));}function getUser(_0x356fd6){const _0x89d7bc=a1_0xfca26b;return UsersState[_0x89d7bc(0x132)][_0x89d7bc(0x170)](_0x4187e3=>_0x4187e3['id']===_0x356fd6);}function getUsersInRoom(_0x5cd095){const _0x4bbd98=a1_0xfca26b;return UsersState[_0x4bbd98(0x132)]['filter'](_0x1753c5=>_0x1753c5[_0x4bbd98(0x141)]===_0x5cd095);}function getAllActiveRooms(){const _0x449115=a1_0xfca26b;return Array[_0x449115(0x165)](new Set(UsersState['users'][_0x449115(0x121)](_0x336404=>_0x336404['room'])));}