name: Deploy VybChat to EC2

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/Test/server

            # Backup chat history before deployment
            echo "ğŸ“¦ Backing up chat history..."
            if [ -f chat-backup.json ]; then
              cp chat-backup.json chat-backup-$(date +%Y%m%d_%H%M%S).json
              echo "âœ… Chat history backed up"
            else
              echo "â„¹ï¸ No existing chat history found"
            fi

            # Backup current chat state if server is running
            if pm2 list | grep -q "vybchat.*online"; then
              echo "ğŸ’¾ Creating backup from running server..."
              node backup.js || echo "âš ï¸ Backup script failed, continuing with deployment"
            fi

            git fetch origin
            git reset --hard origin/production

            echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" > .env
            echo "PORT=${{ secrets.PORT }}" >> .env
            echo "AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}" >> .env

            npm install
            rm -rf dist build .next .cache tmp
            npm run build || true
              # Stop server gracefully to allow chat backup
            pm2 delete vybchat || true
            pm2 flush
            
            # Start server (it will automatically restore chat history)
            pm2 start npm --name vybchat -- run start
            
            # Wait for server to start and restore chat history
            echo "â³ Waiting for server to start..."
            sleep 10
            
            # Verify server is running
            if pm2 list | grep -q "vybchat.*online"; then
              echo "âœ… Server started successfully"
              # Clean up backup file after successful restore
              if [ -f chat-backup.json ]; then
                rm chat-backup.json
                echo "ğŸ—‘ï¸ Backup file cleaned up after successful restore"
              fi
            else
              echo "âŒ Server failed to start"
              exit 1
            fi
            
            echo "ğŸš€ Deployment completed successfully!"
          EOF
